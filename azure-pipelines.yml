trigger:
- main

variables:
- group: TP7-Variables   # SOLO SONAR_TOKEN adentro

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1) Instalar Node.js
- task: UseNode@1
  inputs:
    version: '20.x'
    checkLatest: true

# 2) Backend - instalar deps
- script: |
    cd backend
    npm install
  displayName: "Instalar dependencias del backend"

# 3) Backend - tests + coverage
- script: |
    cd backend
    npm test -- --coverage
  displayName: "Ejecutar tests backend"

# 4) Frontend - instalar deps
- script: |
    cd frontend
    npm install
  displayName: "Instalar dependencias frontend"

# 5) Frontend - tests + coverage
- script: |
    cd frontend
    npm test -- --coverage
  displayName: "Ejecutar tests frontend"

# 6) SonarCloud - análisis con SonarScanner CLI (proyecto JS, no .NET)
- task: Bash@3
  displayName: "SonarCloud - análisis"
  inputs:
    targetType: inline
    script: |
      # Descargar SonarScanner CLI
      SCANNER_VERSION=5.0.1.3006
      SCANNER_DIR="sonar-scanner-$SCANNER_VERSION-linux"

      wget -qO sonar-scanner.zip "https://github.com/SonarSource/sonar-scanner-cli/releases/download/v$SCANNER_VERSION/sonar-scanner-cli-$SCANNER_VERSION-linux.zip"
      unzip -q sonar-scanner.zip
      export PATH="$PATH:$(pwd)/$SCANNER_DIR/bin"

      echo "Ejecutando análisis SonarCloud..."

      sonar-scanner \
        -Dsonar.projectKey=Cervellini2501_TP7-IngSoftIII \
        -Dsonar.organization=cervellini2501 \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.token="$(SONAR_TOKEN)" \
        -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info,frontend/coverage/lcov.info"
