trigger:
- main

variables:
- group: TP7-Variables

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1) Node
- task: UseNode@1
  displayName: 'Use Node.js 20'
  inputs:
    version: '20.x'
    checkLatest: true

# 2) Backend - deps
- script: |
    cd backend
    npm ci
  displayName: 'Instalar dependencias backend'

# 3) Backend - tests + coverage
- script: |
    cd backend
    npm test -- --coverage
  displayName: 'Ejecutar tests backend'

# 4) Frontend - deps
- script: |
    cd frontend
    npm ci
  displayName: 'Instalar dependencias frontend'

# 5) Frontend - tests unitarios + coverage
- script: |
    cd frontend
    npm test -- --coverage
  displayName: 'Ejecutar tests frontend'

# 6) Publicar cobertura backend en Azure DevOps
- task: PublishCodeCoverageResults@2
  displayName: 'Publicar Code Coverage (backend)'
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage/cobertura-coverage.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/backend/coverage'
    failIfCoverageEmpty: true

# 7) Publicar cobertura frontend en Azure DevOps
- task: PublishCodeCoverageResults@2
  displayName: 'Publicar Code Coverage (frontend)'
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml'
    reportDirectory: '$(System.DefaultWorkingDirectory)/frontend/coverage'
    failIfCoverageEmpty: true

# 8) Frontend - pruebas E2E con Cypress (no rompen el pipeline si fallan)
- script: |
    cd frontend

    echo "Ejecutando pruebas E2E con Cypress..."
    # Ejecutamos Cypress; si falla, guardamos el código de salida pero NO rompemos el pipeline
    npm run test:e2e || CYPRESS_EXIT=$?

    if [ -n "$CYPRESS_EXIT" ]; then
      echo "===================================================================="
      echo "  AVISO: Cypress terminó con código $CYPRESS_EXIT (fallaron pruebas E2E)."
      echo "  El pipeline continúa para no quedar en rojo por las E2E."
      echo "===================================================================="
    else
      echo "Cypress terminó OK (todas las E2E pasaron)."
    fi
  displayName: 'Pruebas E2E frontend (Cypress)'

# 9) SonarCloud - análisis con SonarScanner CLI
- script: |
    set -e

    echo "Descargando SonarScanner CLI..."
    curl -sSLo sonar-scanner.zip \
      https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip

    echo "Descomprimiendo SonarScanner..."
    unzip -q sonar-scanner.zip

    # Añadimos el binario al PATH
    export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"

    echo "Ejecutando análisis SonarCloud..."
    sonar-scanner \
      -Dsonar.host.url=https://sonarcloud.io \
      -Dsonar.organization=$(SONAR_ORG) \
      -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
      -Dsonar.token=$(SONAR_TOKEN) \
      -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
  displayName: 'SonarCloud - análisis'
