trigger:
- main

variables:
- group: TP7-Variables

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1) Node
- task: UseNode@1
  displayName: 'Use Node.js 20'
  inputs:
    version: '20.x'
    checkLatest: true

# 2) Backend - deps
- script: |
    cd backend
    npm ci
  displayName: 'Instalar dependencias backend'

# 3) Backend - tests + coverage
- script: |
    cd backend
    npm test -- --coverage
  displayName: 'Ejecutar tests backend'

# 4) Frontend - deps
- script: |
    cd frontend
    npm ci
  displayName: 'Instalar dependencias frontend'

# 5) Frontend - tests + coverage
- script: |
    cd frontend
    npm test -- --coverage
  displayName: 'Ejecutar tests frontend'

# 6) SonarCloud - an치lisis con SonarScanner CLI
- script: |
    set -e

    echo "Descargando SonarScanner CLI..."
    curl -sSLo sonar-scanner.zip \
      https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip

    echo "Descomprimiendo SonarScanner..."
    unzip -q sonar-scanner.zip

    # A침adimos el binario al PATH
    export PATH="$PATH:$(pwd)/sonar-scanner-5.0.1.3006-linux/bin"

    echo "Ejecutando an치lisis SonarCloud..."
    sonar-scanner \
      -Dsonar.host.url=https://sonarcloud.io \
      -Dsonar.organization=$(SONAR_ORG) \
      -Dsonar.projectKey=$(SONAR_PROJECT_KEY) \
      -Dsonar.token=$(SONAR_TOKEN) \
      -Dsonar.javascript.lcov.reportPaths=backend/coverage/lcov.info,frontend/coverage/lcov.info
  displayName: 'SonarCloud - an치lisis'
