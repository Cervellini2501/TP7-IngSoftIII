trigger:
- main

variables:
- group: TP7-Variables

pool:
  vmImage: 'ubuntu-latest'

steps:
# 1) Instalar Node.js
- task: UseNode@1
  inputs:
    version: '18.x'

# 2) Backend - instalar deps
- script: |
    cd backend
    npm install
  displayName: "Instalar dependencias del backend"

# 3) Backend - tests + coverage
- script: |
    cd backend
    npm test -- --coverage
  displayName: "Ejecutar tests backend"

# 4) Frontend - instalar deps
- script: |
    cd frontend
    npm install
  displayName: "Instalar dependencias frontend"

# 5) Frontend - tests + coverage
- script: |
    cd frontend
    npm test -- --coverage
  displayName: "Ejecutar tests frontend"

# 6) Descargar SonarScanner
- script: |
    dotnet tool install --global dotnet-sonarscanner
  displayName: "Instalar SonarScanner"

# 7) SonarCloud - BEGIN
- script: |
    dotnet-sonarscanner begin \
      /k:"$(SONAR_PROJECT_KEY)" \
      /o:"$(SONAR_ORG)" \
      /d:sonar.token="$(SONAR_TOKEN)" \
      /d:sonar.javascript.lcov.reportPaths="backend/coverage/lcov.info,frontend/coverage/lcov.info"
  displayName: "SonarCloud BEGIN"

# 8) Build vacío (obligatorio para cerrar el análisis)
- script: |
    echo "Build necesario para SonarScanner"
  displayName: "Fake build"

# 9) SonarCloud - END
- script: |
    dotnet-sonarscanner end /d:sonar.token="$(SONAR_TOKEN)"
  displayName: "SonarCloud END"
